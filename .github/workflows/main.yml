name: Build and Deploy Project

on:
  workflow_dispatch:
    inputs:
      zip_url:
        description: 'URL zur ZIP-Datei'
        required: true
  repository_dispatch:
    types: [build-project]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Erlaubt das Erstellen von Releases
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Download ZIP file
      run: |
        ZIP_URL=""
        if [ -n "${{ github.event.inputs.zip_url }}" ]; then
          ZIP_URL="${{ github.event.inputs.zip_url }}"
        elif [ -n "${{ github.event.client_payload.zip_url }}" ]; then
          ZIP_URL="${{ github.event.client_payload.zip_url }}"
        fi
        
        if [ -z "$ZIP_URL" ]; then
          echo "‚ùå Fehler: Keine ZIP-URL angegeben!"
          exit 1
        fi
        
        echo "üì• Lade Datei von: $ZIP_URL"
        curl -L -f -o project.zip "$ZIP_URL" || {
          echo "‚ùå Fehler beim Herunterladen"
          exit 1
        }
        
        # Pr√ºfe ob Datei existiert und nicht leer ist
        if [ ! -f project.zip ] || [ ! -s project.zip ]; then
          echo "‚ùå Fehler: Datei wurde nicht heruntergeladen oder ist leer"
          exit 1
        fi
        
        # Pr√ºfe ob es eine ZIP-Datei ist (beginnt mit "PK")
        FILE_TYPE=$(file -b project.zip)
        FIRST_BYTES=$(head -c 2 project.zip | od -An -tx1 | tr -d ' \n')
        
        echo "üìä Dateigr√∂√üe: $(ls -lh project.zip | awk '{print $5}')"
        echo "üìã Dateityp: $FILE_TYPE"
        echo "üîç Erste Bytes: $FIRST_BYTES"
        
        if [ "$FIRST_BYTES" != "504b" ]; then
          echo "‚ùå Fehler: Datei ist keine g√ºltige ZIP-Datei!"
          echo "Die Datei beginnt nicht mit 'PK' (ZIP-Signatur)"
          echo "M√∂glicherweise wurde eine HTML-Seite statt der ZIP-Datei heruntergeladen."
          echo "Bitte √ºberpr√ºfe die URL und stelle sicher, dass sie direkt auf eine ZIP-Datei zeigt."
          head -n 20 project.zip
          exit 1
        fi
        
        echo "‚úÖ ZIP-Datei erfolgreich validiert"
    
    - name: Extract ZIP
      run: |
        echo "üì¶ Extrahiere ZIP-Datei..."
        if ! unzip -q project.zip -d project/; then
          echo "‚ùå Fehler beim Extrahieren der ZIP-Datei"
          echo "Die ZIP-Datei k√∂nnte besch√§digt sein."
          exit 1
        fi
        
        cd project/
        
        # Finde das Hauptverzeichnis (wenn ZIP einen Wrapper-Ordner enth√§lt)
        DIR_COUNT=$(ls -d */ 2>/dev/null | wc -l)
        FILE_COUNT=$(ls -1 2>/dev/null | grep -v '^\.' | wc -l)
        
        if [ "$DIR_COUNT" -eq 1 ] && [ "$FILE_COUNT" -eq 1 ]; then
          SUBDIR=$(ls -d */ | head -1)
          echo "üìÅ Verschiebe Inhalt aus $SUBDIR..."
          mv "$SUBDIR"* . 2>/dev/null || true
          rmdir "$SUBDIR" 2>/dev/null || true
        fi
        
        cd ..
        echo "‚úÖ Extraktion abgeschlossen"
        echo "üìÅ Inhalt:"
        ls -la project/ | head -20
    
    - name: Setup npm cache (if lock file exists)
      working-directory: ./project
      run: |
        if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ] || [ -f yarn.lock ]; then
          echo "Lock file found, cache will be used"
        else
          echo "No lock file found, skipping cache"
        fi
    
    - name: Install dependencies
      working-directory: ./project
      run: |
        if [ -f package.json ]; then
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
        fi
    
    - name: Build project
      working-directory: ./project
      run: |
        if [ -f package.json ]; then
          npm run build || npm run build:prod || echo "No build script found"
        fi
    
    - name: Create compiled ZIP
      run: |
        cd project
        # Finde den Build-Ordner
        if [ -d "dist" ]; then
          cd dist
        elif [ -d "build" ]; then
          cd build
        elif [ -d "out" ]; then
          cd out
        fi
        zip -r ../../compiled-project.zip .
        cd ../..
    
    - name: Upload compiled ZIP as artifact
      uses: actions/upload-artifact@v4
      with:
        name: compiled-project
        path: compiled-project.zip
        retention-days: 7
    
    - name: Create Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        files: compiled-project.zip
        tag_name: compiled-v${{ github.run_number }}
        name: Compiled Project v${{ github.run_number }}
        body: |
          Automatisch kompilierte Version des Projekts
          
          **Build-Datum:** ${{ github.event.head_commit.timestamp || github.run_started_at }}
          **Commit:** ${{ github.sha }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

